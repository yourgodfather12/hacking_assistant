import subprocess
import shlex
from config import METASPLOIT_CMD
import logging

logger = logging.getLogger(__name__)

def sanitize_input(value):
    # Simple sanitization, can be enhanced based on requirements
    return shlex.quote(value)

def run_exploit(target, exploit, payload):
    target = sanitize_input(target)
    exploit = sanitize_input(exploit)
    payload = sanitize_input(payload)

    command = f"{METASPLOIT_CMD} -q -x 'use {exploit}; set RHOST {target}; set PAYLOAD {payload}; exploit; exit'"
    try:
        result = subprocess.run(shlex.split(command), capture_output=True, text=True, check=True)
        return result.stdout
    except subprocess.CalledProcessError as e:
        logger.error(f"Metasploit command failed: {e}")
        return f"An error occurred: {e.output}"
    except Exception as e:
        logger.error(f"Unexpected error: {e}")
        return f"Unexpected error: {e}"
